CREATE DATABASE QLVRP

ON PRIMARY
(NAME=QLBH_DATA,
FILENAME="D:\HSK_SQL\QLVRP\QLVRP_DATA.mdf",
SIZE=25MB,
MAXSIZE=35MB,
FILEGROWTH=5MB
)
LOG ON
(NAME=QLVRP_LOG,
FILENAME="D:\HSK_SQL\QLVRP\QLVRP_LOG.ldf",
SIZE=15MB,
MAXSIZE=25MB,
FILEGROWTH=3MB
)

CREATE TABLE NHANVIEN
(MaNV CHAR(10) NOT NULL,
TenNV NVARCHAR(30) NOT NULL,
SoCCCD INT,
SoDT INT,
ChucVu NVARCHAR(20) NOT NULL,
GioiTinh NVARCHAR(10),
NgaySinh DATETIME,
MatKH CHAR(20) NOT NULL
)

CREATE TABLE KHACHHANG
(MaKH CHAR(5) NOT NULL,
TenKH NVARCHAR(30) NOT NULL,
SoDT INT,
GioiTinh NVARCHAR(10),
NgaySinh DATETIME
)

CREATE TABLE HOADON
(MaHD CHAR(10) NOT NULL,
NgayXHD DATETIME,
Manv char(10),
Makh CHAR(5)
)

CREATE TABLE VEBAN
(MaVB CHAR(10) NOT NULL,
NgayBD DATETIME,
NgayKT DATETIME,
LVe CHAR(5) NOT NULL,
Mahd CHAR(10),
Masc CHAR(5),
Magn CHAR(5)
)

CREATE TABLE CT_HOADON
(Mahd CHAR(10) NOT NULL,
GiaT MONEY,
SoL INT
)

CREATE TABLE SUATCHIEU
(MaSC CHAR(5)NOT NULL,
GioBD DATETIME,
GioKT DATETIME,
NgayChieu DATETIME,
Maphim CHAR(5),
Mapc CHAR(5)
)

CREATE TABLE PHIM
(MaPHIM CHAR(5) NOT NULL,
TenPhim NVARCHAR(30) NOT NULL,
ThoiLuong TIME,
DoTuoi INT NOT NULL,
NgayCongChieu DATETIME NOT NULL,
NhaSX NVARCHAR(30) NOT NULL,
LoaiPhim NVARCHAR(20) NOT NULL,
Masc CHAR(5)
)

CREATE TABLE PHONGCHIEU
(MaPC CHAR(5) NOT NULL,
TenPC NVARCHAR(10)NOT NULL,
TrangThai NVARCHAR(20),
SucChua INT
)

CREATE TABLE GHENGOI
(MaGN CHAR(5) NOT NULL,
ViTriGN CHAR(5),
TrangThai NVARCHAR(10) NOT NULL,
LoaiGN CHAR(10) CHECK(LoaiGN IN ('VIP','PROVIP','TH')) NOT NULL,
Mapc CHAR(5)
)

ALTER TABLE NHANVIEN
	ADD CONSTRAINT PK_MaNV PRIMARY KEY (MaNV)

ALTER TABLE KHACHHANG
	ADD CONSTRAINT PK_MaKH PRIMARY KEY (MaKH)

ALTER TABLE HOADON
	ADD CONSTRAINT PK_MaHD PRIMARY KEY (MaHD)

ALTER TABLE CT_HOADON
	ADD CONSTRAINT PK_CT_Mahd PRIMARY KEY (Mahd)

ALTER TABLE VEBAN
	ADD CONSTRAINT PK_MaVB PRIMARY KEY (MaVB)

ALTER TABLE SUATCHIEU
	ADD CONSTRAINT PK_MaSC PRIMARY KEY (MaSC)

ALTER TABLE PHONGCHIEU
	ADD CONSTRAINT PK_MPC PRIMARY KEY (MaPC)

ALTER TABLE GHENGOI
	ADD CONSTRAINT PK_MaGN PRIMARY KEY (MaGN)

ALTER TABLE PHIM
	ADD CONSTRAINT PK_MaPhim PRIMARY KEY (MaPHIM)

ALTER TABLE HOADON
	ADD CONSTRAINT FK_HD_Manv FOREIGN KEY(Manv) REFERENCES NHANVIEN(MaNV)

ALTER TABLE HOADON
	ADD CONSTRAINT FK_HD_Makh FOREIGN KEY(Makh) REFERENCES KHACHHANG(Makh)

ALTER TABLE CT_HOADON
	ADD CONSTRAINT FK_CT_Mahd FOREIGN KEY(Mahd) REFERENCES HOADON(MaHD)

ALTER TABLE VEBAN
	ADD CONSTRAINT FK_VB_Mahd FOREIGN KEY(Mahd) REFERENCES HOADON(MaHD)

ALTER TABLE VEBAN
	ADD CONSTRAINT FK_VB_Magn FOREIGN KEY(Magn) REFERENCES GHENGOI(MaGN)

ALTER TABLE VEBAN
	ADD CONSTRAINT FK_VB_Masc FOREIGN KEY(Masc) REFERENCES SUATCHIEU(MaSC)

ALTER TABLE GHENGOI
	ADD CONSTRAINT FK_GN_Mapc FOREIGN KEY(Mapc) REFERENCES PHONGCHIEU(MaPC)

ALTER TABLE SUATCHIEU
	ADD CONSTRAINT FK_SC_Mapc FOREIGN KEY(Mapc) REFERENCES PHONGCHIEU(MaPC)

ALTER TABLE PHIM
	ADD CONSTRAINT FK_P_Masc FOREIGN KEY(Masc) REFERENCES SUATCHIEU(MaSC)

SET DATEFORMAT 'DMY'

SELECT P.TenPhim, SC.NgayChieu, COUNT(VB.MaVB), VB.LVe
FROM PHIM P JOIN SUATCHIEU SC ON P.Masc=SC.MaSC JOIN VEBAN VB ON SC.MaSC=VB.Masc
WHERE MONTH(SC.NgayChieu) BETWEEN 5 AND 10 AND YEAR(SC.NgayChieu) = 2023
GROUP BY P.TenPhim, SC.NgayChieu, VB.LVe
